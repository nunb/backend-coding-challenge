<title>Coveo's Backend Challenge's Frontend</title>
<div><input id="suggestion" placeholder="Location" /> <input id="suglat" type="number" step="0.000001" placeholder="Latitude" /> <input id="suglong" type="number" step="0.00001" placeholder="Longitude" /></div>
<div><input id="sugradius" type="number" placeholder="Radius (km)" /></div>
<div id="msg" style="display:none"></div>
<div>
    <img id="map" src="https://upload.wikimedia.org/wikipedia/commons/7/74/North_America_blank_map_with_state_and_province_boundaries.png" style="positon:inline-block;width:400px;vertical-align:top" />
    <table style="display:none;vertical-align:top" id="loctab">
        <thead>
            <tr>
                <th>Location</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Score</th>
            </tr>
        </thead>
    </table>
</div>
<script async>"use strict";
var suggestion = document.getElementById("suggestion");
var suglat = document.getElementById("suglat");
var suglong = document.getElementById("suglong");
var sugradius = document.getElementById("sugradius");
var loctab = document.getElementById("loctab");
var map = document.getElementById("map");
var msg = document.getElementById("msg");
var suggestDelay = null;
var mapRect = {
    w: -171,
    e: -48,
    n: 83,
    s: 25,
};
function doSearchSoon() {
    if (suggestDelay) {
        clearTimeout(suggestDelay);
    }
    suggestDelay = setTimeout(function(){
        doSearch();
    }, 90);
}
var inputFields = [suggestion, suglat, suglong, sugradius];
for (var i = 0; i<inputFields.length; i++) {
    inputFields[i].addEventListener("input", doSearchSoon);
    inputFields[i].addEventListener("keydown", function(e){
        if (e.keyCode == 13) {
            doSearch();
        }
    });
}
map.addEventListener("mousedown", function(e) {
    suglat.value = (mapRect.n - (mapRect.n - mapRect.s) * (e.pageY - this.offsetTop) / this.offsetHeight).toFixed(6);
    suglong.value = (mapRect.w - (mapRect.w - mapRect.e) * (e.pageX - this.offsetLeft) / this.offsetWidth).toFixed(6);
    doSearch();
});
function doSearch() {
    if (suggestDelay) {
        clearTimeout(suggestDelay);
        suggestDelay = null;
    }
    msg.style.display = "block";
    msg.textContent = "Searching for '" + suggestion.value + "'";
    var xhr = new XMLHttpRequest();
    var query = "/suggestions?q=" + encodeURIComponent(suggestion.value);
    if (suglat.value) query += "&latitude=" + suglat.value;
    if (suglong.value) query += "&longitude=" + suglong.value;
    if (sugradius.value) query += "&radius=" + sugradius.value;
    xhr.open("GET", query, true);
    xhr.addEventListener("load", function(){
        var data = JSON.parse(this.responseText);
        if (data.err) {
            msg.textContent = data.err;
            msg.style.display = "block";
            loctab.style.display = "none";
        }
        else if (data.suggestions) {
            if (data.suggestions.length) {
                msg.style.display = "none";
                loctab.style.display = "inline-block";
                while (loctab.rows.length > 1) loctab.deleteRow(-1);
                for (var i = 0; i<data.suggestions.length; i++) {
                    var row = loctab.insertRow();
                    row.insertCell().textContent = data.suggestions[i].name;
                    row.insertCell().textContent = data.suggestions[i].latitude;
                    row.insertCell().textContent = data.suggestions[i].longitude;
                    row.insertCell().textContent = data.suggestions[i].score;
                }
            } else {
                msg.textContent = "No results found";
                msg.style.display = "block";
                loctab.style.display = "none";
            }
        }
    });
    xhr.send();
}
</script>
